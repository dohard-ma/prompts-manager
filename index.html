<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Lab - 原生原子化迭代实验室</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains+Mono', monospace; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .hidden { display: none; }
        .rotate-180 { transform: rotate(180deg); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-20">

    <div id="app">
        <!-- 导航栏 -->
        <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur-xl border-b border-slate-200 px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="p-2 bg-slate-900 rounded-xl" id="logo-icon"></div>
                <div class="h-8 w-px bg-slate-200"></div>
                <div class="relative">
                    <button id="project-dropdown-btn" class="flex items-center gap-2 bg-slate-100 px-4 py-2 rounded-xl font-bold text-sm hover:bg-slate-200 transition-all">
                        <span id="current-project-icon" class="text-indigo-600"></span>
                        <span id="current-project-name">加载中...</span>
                        <span id="dropdown-arrow"></span>
                    </button>
                    <!-- 下拉菜单 -->
                    <div id="project-menu" class="hidden absolute top-full left-0 mt-2 w-64 bg-white rounded-2xl shadow-2xl border border-slate-100 p-2 z-[60]">
                        <div id="project-list-container"></div>
                        <button id="show-add-project-btn" class="w-full text-left px-4 py-3 rounded-xl text-sm font-bold text-indigo-600 hover:bg-indigo-50 mt-2 border-t pt-2 flex items-center gap-2">
                            <span id="plus-icon"></span> 创建新项目
                        </button>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button id="settings-btn" class="p-3 text-slate-400 hover:bg-slate-100 rounded-xl transition-all"></button>
                <button id="toggle-add-btn" class="flex items-center gap-2 bg-indigo-600 text-white px-6 py-3 rounded-2xl font-bold shadow-xl shadow-indigo-100 hover:bg-indigo-700 transition-all active:scale-95">
                    <span id="main-plus-icon"></span> <span class="hidden sm:inline" id="btn-text">记录迭代</span>
                </button>
            </div>
        </nav>

        <main class="max-w-5xl mx-auto px-6 py-10">
            <!-- 引导栏 -->
            <div class="mb-8 flex items-center gap-2 opacity-40">
                <span id="grid-icon"></span>
                <span class="text-[10px] font-black uppercase tracking-widest">原子化场景管理 / 迭代历史</span>
            </div>

            <!-- 新增迭代卡片 -->
            <div id="add-form-container" class="hidden mb-12 bg-white rounded-[2.5rem] shadow-2xl border border-slate-200 overflow-hidden animate-in">
                <div class="bg-indigo-600 px-8 py-6 flex justify-between items-center text-white">
                    <h2 class="font-bold flex items-center gap-2"><span id="sparkles-icon"></span> 迭代分析录入</h2>
                    <button id="ai-analyze-btn" class="bg-white text-indigo-600 px-5 py-2 rounded-full font-bold text-xs flex items-center gap-2 shadow-lg hover:bg-indigo-50 disabled:opacity-50 transition-all">
                        <span id="btn-spark-icon"></span> AI 智能填充报告
                    </button>
                </div>
                <div class="p-8 space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <textarea id="input-en" placeholder="1. 粘贴英文提示词..." class="w-full px-5 py-4 bg-slate-50 border-2 border-transparent focus:border-indigo-600 focus:bg-white rounded-2xl outline-none transition-all font-mono text-xs h-40"></textarea>
                            <textarea id="input-thoughts" placeholder="2. 描述你的原始想法或反馈（AI会根据此内容分析迭代逻辑）..." class="w-full px-5 py-4 bg-indigo-50/30 border-2 border-transparent focus:border-indigo-600 focus:bg-white rounded-2xl outline-none transition-all text-xs h-24"></textarea>
                        </div>
                        <div class="bg-slate-50 p-6 rounded-2xl space-y-4 shadow-inner border border-slate-100">
                            <input id="input-title" placeholder="版本标题" class="w-full px-4 py-2 bg-white border border-slate-200 rounded-xl text-sm font-bold outline-none" />
                            <textarea id="input-reason" placeholder="迭代理由" class="w-full px-4 py-2 bg-white border border-slate-200 rounded-xl text-xs h-16 outline-none"></textarea>
                            <textarea id="input-imperfection" placeholder="不足之处" class="w-full px-4 py-2 bg-white border border-slate-200 rounded-xl text-xs h-16 text-rose-600 outline-none"></textarea>
                            <textarea id="input-zh" placeholder="提示词翻译" class="w-full px-4 py-2 bg-white border border-slate-200 rounded-xl text-xs italic h-16 outline-none"></textarea>
                        </div>
                    </div>
                    <button id="save-version-btn" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black text-lg shadow-xl hover:bg-black transition-all">确认并保存到当前场景</button>
                </div>
            </div>

            <!-- 列表容器 -->
            <div id="version-list" class="space-y-8"></div>
        </main>
    </div>

    <!-- API Key 配置弹窗 -->
    <div id="settings-modal" class="hidden fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-md p-8 border border-white">
            <h2 class="text-xl font-bold mb-2 flex items-center gap-2 text-slate-800">API KEY 设置</h2>
            <p class="text-sm text-slate-500 mb-6">请输入 Google AI Studio 的 API Key 启用全自动化分析功能。</p>
            <input type="password" id="api-key-input" class="w-full px-5 py-4 bg-slate-50 border border-slate-200 rounded-2xl mb-6 outline-none focus:ring-2 focus:ring-indigo-600 font-mono" placeholder="Paste Key..."/>
            <button id="save-settings-btn" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-bold hover:bg-indigo-700 transition-all">保存设置</button>
        </div>
    </div>

    <!-- 新增项目弹窗 -->
    <div id="project-modal" class="hidden fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] shadow-2xl w-full max-w-md p-8">
            <h2 class="text-xl font-bold mb-4 text-slate-800">创建新场景项目</h2>
            <input id="new-project-input" class="w-full px-5 py-4 bg-slate-50 border border-slate-200 rounded-2xl mb-6 outline-none focus:ring-2 focus:ring-indigo-600" placeholder="例如：美女图片生成..."/>
            <div class="flex gap-3">
                <button id="cancel-project-btn" class="flex-1 font-bold text-slate-400">取消</button>
                <button id="confirm-project-btn" class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-bold">立即创建</button>
            </div>
        </div>
    </div>

    <script>
        // --- 图标库 (原生实现) ---
        const getIcon = (name, size = 18, cls = "") => {
            const icons = {
                beaker: `<path d="M4.5 3h15M6 3v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V3M6 14h12" />`,
                plus: `<path d="M12 5v14M5 12h14" />`,
                x: `<path d="M18 6 6 18M6 6l12 12" />`,
                copy: `<rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />`,
                check: `<path d="M20 6 9 17l-5-5" />`,
                trash: `<path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6" />`,
                sparkles: `<path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.937A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .962 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.582a.5.5 0 0 1 0 .962L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.962 0zM20 3v4M22 5h-4M4 17v2M5 18H3" />`,
                settings: `<path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2zM12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />`,
                folder: `<path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2z" />`,
                chevronDown: `<path d="m6 9 6 6 6-6" />`,
                grid: `<path d="M3 3h7v7H3zM14 3h7v7h-7zM14 14h7v7h-7zM3 14h7v7H3z" />`
            };
            return `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${cls}">${icons[name] || ''}</svg>`;
        };

        // --- 核心逻辑 ---
        const state = {
            projects: [],
            activeProjectId: null,
            versions: [],
            isAdding: false,
            apiKey: localStorage.getItem('gemini_api_key') || ''
        };

        // 存储
        const saveState = () => {
            localStorage.setItem('prompt_lab_projects', JSON.stringify(state.projects));
            localStorage.setItem('prompt_lab_history', JSON.stringify(state.versions));
            localStorage.setItem('prompt_lab_active_id', state.activeProjectId);
        };

        // 初始化加载
        const loadState = () => {
            const p = localStorage.getItem('prompt_lab_projects');
            state.projects = p ? JSON.parse(p) : [{ id: 'p1', name: '花束摄影生成', createdAt: new Date() }];
            const v = localStorage.getItem('prompt_lab_history');
            state.versions = v ? JSON.parse(v) : [];
            state.activeProjectId = localStorage.getItem('prompt_lab_active_id') || state.projects[0].id;
        };

        // UI 渲染
        const render = () => {
            const currentProj = state.projects.find(p => p.id === state.activeProjectId);
            
            // 导航
            document.getElementById('current-project-name').innerText = currentProj ? currentProj.name : '选择场景';
            document.getElementById('logo-icon').innerHTML = getIcon('beaker', 18, 'text-white');
            document.getElementById('current-project-icon').innerHTML = getIcon('folder', 14);
            document.getElementById('dropdown-arrow').innerHTML = getIcon('chevronDown', 12);
            document.getElementById('settings-btn').innerHTML = getIcon('settings', 20);
            document.getElementById('main-plus-icon').innerHTML = getIcon(state.isAdding ? 'x' : 'plus', 18);
            document.getElementById('plus-icon').innerHTML = getIcon('plus', 14);
            document.getElementById('grid-icon').innerHTML = getIcon('grid', 14);
            document.getElementById('btn-spark-icon').innerHTML = getIcon('sparkles', 12);
            document.getElementById('sparkles-icon').innerHTML = getIcon('sparkles', 20);

            // 切换面板显示
            document.getElementById('add-form-container').classList.toggle('hidden', !state.isAdding);
            document.getElementById('btn-text').innerText = state.isAdding ? '取消' : '记录迭代';

            // 渲染项目列表
            const projectListHtml = state.projects.map(p => `
                <button onclick="switchProject('${p.id}')" class="w-full text-left px-4 py-3 rounded-xl text-sm font-bold flex items-center justify-between ${state.activeProjectId === p.id ? 'bg-indigo-50 text-indigo-600' : 'hover:bg-slate-50'}">
                    ${p.name}
                    ${state.activeProjectId === p.id ? getIcon('check', 14) : ''}
                </button>
            `).join('');
            document.getElementById('project-list-container').innerHTML = projectListHtml;

            // 渲染版本列表
            const filteredVersions = state.versions.filter(v => v.projectId === state.activeProjectId)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            const listHtml = filteredVersions.length === 0 ? `
                <div class="py-32 text-center opacity-20">
                    <p class="font-bold tracking-widest uppercase text-xs">暂无此场景迭代数据</p>
                </div>
            ` : filteredVersions.map((v, idx) => `
                <div class="bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden hover:shadow-xl transition-all duration-300">
                    <div class="px-8 py-5 border-b border-slate-50 bg-slate-50/30 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <div class="px-2 py-0.5 bg-indigo-600 text-white text-[9px] font-black rounded uppercase">V${filteredVersions.length - idx}</div>
                            <h3 class="font-bold text-lg text-slate-800 tracking-tight">${v.title}</h3>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="copyEn('${v.id}')" class="flex items-center gap-2 px-4 py-1.5 bg-white border border-slate-200 rounded-xl hover:text-indigo-600 hover:border-indigo-600 transition-all text-[10px] font-black uppercase">
                                <span id="copy-icon-${v.id}">${getIcon('copy', 12)}</span>
                                <span id="copy-text-${v.id}">Copy En</span>
                            </button>
                            <button onclick="deleteVersion('${v.id}')" class="p-2 text-slate-200 hover:text-rose-500 transition-colors">${getIcon('trash', 16)}</button>
                        </div>
                    </div>
                    <div class="p-8 space-y-6">
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1 bg-indigo-50/50 p-5 rounded-2xl border border-indigo-100">
                                <h4 class="text-indigo-600 text-[9px] font-black uppercase tracking-widest mb-2 flex items-center gap-2">${getIcon('plus', 10)} 改进逻辑</h4>
                                <p class="text-xs font-bold text-indigo-900 leading-relaxed">${v.reason}</p>
                            </div>
                            <div class="flex-1 bg-rose-50/50 p-5 rounded-2xl border border-rose-100">
                                <h4 class="text-rose-600 text-[9px] font-black uppercase tracking-widest mb-2 flex items-center gap-2">${getIcon('x', 10)} 尚存不足</h4>
                                <p class="text-xs font-bold text-rose-900 leading-relaxed">${v.imperfection}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="relative">
                                <h4 class="text-[9px] font-black text-slate-300 uppercase mb-2 ml-2">English Prompt</h4>
                                <div id="en-${v.id}" class="bg-slate-900 text-slate-300 p-6 rounded-3xl text-[11px] font-mono leading-relaxed max-h-40 overflow-y-auto border-2 border-slate-800">${v.enPrompt}</div>
                            </div>
                            <div class="relative">
                                <h4 class="text-[9px] font-black text-slate-300 uppercase mb-2 ml-2">中文对照</h4>
                                <div class="bg-slate-50 text-slate-500 p-6 rounded-3xl text-[11px] italic leading-relaxed max-h-40 overflow-y-auto border border-slate-100">${v.zhPrompt}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            document.getElementById('version-list').innerHTML = listHtml;
        };

        // --- 交互事件 ---

        window.switchProject = (id) => {
            state.activeProjectId = id;
            document.getElementById('project-menu').classList.add('hidden');
            saveState();
            render();
        };

        window.copyEn = (id) => {
            const text = document.getElementById(`en-${id}`).innerText;
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            
            const btnText = document.getElementById(`copy-text-${id}`);
            const btnIcon = document.getElementById(`copy-icon-${id}`);
            btnText.innerText = 'Copied';
            btnIcon.innerHTML = getIcon('check', 12);
            setTimeout(() => {
                btnText.innerText = 'Copy En';
                btnIcon.innerHTML = getIcon('copy', 12);
            }, 2000);
        };

        window.deleteVersion = (id) => {
            if (confirm("确定要删除这个迭代版本吗？")) {
                state.versions = state.versions.filter(v => v.id !== id);
                saveState();
                render();
            }
        };

        // 事件监听
        document.getElementById('project-dropdown-btn').onclick = () => {
            document.getElementById('project-menu').classList.toggle('hidden');
            document.getElementById('dropdown-arrow').classList.toggle('rotate-180');
        };

        document.getElementById('toggle-add-btn').onclick = () => {
            state.isAdding = !state.isAdding;
            render();
        };

        document.getElementById('settings-btn').onclick = () => {
            document.getElementById('settings-modal').classList.remove('hidden');
            document.getElementById('api-key-input').value = state.apiKey;
        };

        document.getElementById('save-settings-btn').onclick = () => {
            const key = document.getElementById('api-key-input').value;
            state.apiKey = key;
            localStorage.setItem('gemini_api_key', key);
            document.getElementById('settings-modal').classList.add('hidden');
        };

        document.getElementById('show-add-project-btn').onclick = () => {
            document.getElementById('project-modal').classList.remove('hidden');
            document.getElementById('project-menu').classList.add('hidden');
        };

        document.getElementById('cancel-project-btn').onclick = () => {
            document.getElementById('project-modal').classList.add('hidden');
        };

        document.getElementById('confirm-project-btn').onclick = () => {
            const name = document.getElementById('new-project-input').value;
            if (!name) return;
            const newProj = { id: 'p_' + Date.now(), name, createdAt: new Date() };
            state.projects.push(newProj);
            state.activeProjectId = newProj.id;
            saveState();
            document.getElementById('project-modal').classList.add('hidden');
            document.getElementById('new-project-input').value = '';
            render();
        };

        // 保存版本
        document.getElementById('save-version-btn').onclick = () => {
            const title = document.getElementById('input-title').value;
            const en = document.getElementById('input-en').value;
            if (!title || !en) return;

            const newV = {
                id: 'v_' + Date.now(),
                projectId: state.activeProjectId,
                title,
                enPrompt: en,
                zhPrompt: document.getElementById('input-zh').value,
                reason: document.getElementById('input-reason').value,
                imperfection: document.getElementById('input-imperfection').value,
                createdAt: new Date().toISOString()
            };

            state.versions.push(newV);
            saveState();
            state.isAdding = false;
            // 清空
            document.getElementById('input-title').value = '';
            document.getElementById('input-en').value = '';
            document.getElementById('input-zh').value = '';
            document.getElementById('input-reason').value = '';
            document.getElementById('input-imperfection').value = '';
            document.getElementById('input-thoughts').value = '';
            render();
        };

        // AI 分析
        document.getElementById('ai-analyze-btn').onclick = async () => {
            const en = document.getElementById('input-en').value;
            const thoughts = document.getElementById('input-thoughts').value;
            if (!state.apiKey) {
                document.getElementById('settings-modal').classList.remove('hidden');
                return;
            }
            if (!en || !thoughts) return;

            const btn = document.getElementById('ai-analyze-btn');
            btn.disabled = true;
            btn.innerText = "分析中...";

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${state.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `English Prompt: ${en}\nRaw Thoughts: ${thoughts}` }] }],
                        systemInstruction: { parts: [{ text: "You are a professional prompt engineer. Based on the user thoughts, analyze the iteration. Respond in JSON with keys: title, reason, imperfection, zhPrompt. Use Chinese for analysis and translation." }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const res = await response.json();
                const ai = JSON.parse(res.candidates[0].content.parts[0].text);
                
                document.getElementById('input-title').value = ai.title;
                document.getElementById('input-reason').value = ai.reason;
                document.getElementById('input-imperfection').value = ai.imperfection;
                document.getElementById('input-zh').value = ai.zhPrompt;
            } catch (e) {
                alert("AI 分析出错，请检查 API Key");
            } finally {
                btn.disabled = false;
                btn.innerHTML = `${getIcon('sparkles', 12)} AI 辅助分析记录`;
            }
        };

        // 初始化
        window.onload = () => {
            loadState();
            if (!state.apiKey) document.getElementById('settings-modal').classList.remove('hidden');
            render();
        };

        // 点击外部关闭项目菜单
        window.addEventListener('click', (e) => {
            if (!document.getElementById('project-dropdown-btn').contains(e.target) && 
                !document.getElementById('project-menu').contains(e.target)) {
                document.getElementById('project-menu').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
